{% extends 'navbar.html' %}

{% load dict_extras %}
{% load calendario_tags %}

{% block content %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Calendario Semanal</title>
  <!-- CSS de Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>



  <style>
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .navigation a {
      text-decoration: none;
      font-weight: bold;
      color: #333;
      padding: 5px 10px;
      border: 2px solid #ccc;
      border-radius: 5px;
    }

    .week-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .day-column {
      flex: 1;
      background-color: #FFEFE2;
      padding: 10px;
      border-radius: 15px;
    }

    .day-header {
      background-color: #FFD9C2;
      border-radius: 10px;
      padding: 5px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }

    .meal-block {
      background-color: #FFF8F5;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .meal-block:hover {
      background-color: #FFE0D6;
    }

    .meal-block h4 {
      margin: 0 0 5px;
    }

    .meal-item {
      background-color: #FFFFFF;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Estilos para la lista de recetas en el modal */
    .recipe-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .recipe-button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
    }

    .recipe-button:hover {
      background-color: #e2e6ea;
    }
  </style>
</head>

<body>
  <h1>Calendario Semanal</h1>


  <div class="container my-4">
    <h5>Objetivo diario de prote√≠nas</h5>
    <div class="progress">
      <div id="barraProteinas" class="progress-bar bg-success" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <p class="mt-2"><span id="consumidas">0</span>g consumidas</p>
  </div>

  <div class="navigation">
    <a href="{{ prev_week_url }}">‚Üê Anterior</a>
    <a href="{% url 'calendario_semanal' %}">Hoy</a>
    <a href="{{ next_week_url }}">Siguiente ‚Üí</a>
  </div>

  <div class="week-container">
    {% for day in dias %}
      {% get_calendario_for_date day as calendario %}

    <div class="day-column">
      <div class="day-header">
        {{ day|date:"D" }}<br>
        {{ day|date:"d/m" }}<br>
        {{ calendario.proteinas_consumidas }}g / {{ calendario.objetivo_proteico }}g

      </div>

      {% for meal in meal_order %}
      <div class="meal-block" data-meal="{{ meal }}" data-fecha="{{ day|date:'Y-m-d' }}">
        <h4>{{ meal }}</h4>
        <div class="meal-items" style="pointer-events: none;">

        {% for cr in dia_data|dictkey:day %}
        {% if cr.tipo_comida.nombre == meal %}
        <div class="meal-item">
          {{ cr.receta.nombre }}
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

      {% endfor %}
    </div>
    {% endfor %}
  </div>

  <!-- Modal para seleccionar receta -->
  <div class="modal fade" id="seleccionarRecetaModal" tabindex="-1" aria-labelledby="seleccionarRecetaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gesti√≥n de recetas para <span id="modalMealType"></span> del <span
              id="modalFecha"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Secci√≥n 1: Recetas ya a√±adidas con opci√≥n de eliminar -->
          <h6>Recetas a√±adidas:</h6>
          <div id="addedRecipeList" class="recipe-list mb-3">
            <p class="text-muted">Cargando...</p>
          </div>

          <hr>

          <!-- Secci√≥n 2: Lista de recetas disponibles para a√±adir -->
          <h6>A√±adir nueva receta:</h6>
          <div id="recipeList" class="recipe-list">
            <p class="text-muted">Cargando...</p>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function actualizarBarraProteinas(fecha) {
      fetch(`/api/calendario_dia/?fecha=${fecha}`)
        .then(res => res.json())
        .then(data => {
          const objetivo = data.objetivo_proteico || 100;
          const consumidas = data.proteinas_consumidas || 0;
          const porcentaje = Math.min((consumidas / objetivo) * 100, 100);
          document.getElementById('barraProteinas').style.width = porcentaje + '%';
          document.getElementById('barraProteinas').textContent = `${Math.round(porcentaje)}%`;
          document.getElementById('consumidas').textContent = consumidas;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      actualizarBarraProteinas(new Date().toISOString().split('T')[0]);
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var mealMapping = {{ meal_mapping|safe}};

    document.body.addEventListener("click", function (event) {
      var mealBlock = event.target.closest(".meal-block");
      if (!mealBlock) return;

      var mealType = mealBlock.dataset.meal;
      var fecha = mealBlock.dataset.fecha;

      document.getElementById("modalMealType").textContent = mealType;
      document.getElementById("modalFecha").textContent = fecha;
      document.getElementById("seleccionarRecetaModal").dataset.meal = mealType;
      document.getElementById("seleccionarRecetaModal").dataset.fecha = fecha;

      var addedRecipeList = document.getElementById("addedRecipeList");
      var recipeList = document.getElementById("recipeList");

      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      // 1Ô∏è‚É£ Cargar recetas ya a√±adidas
      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      // Cargar recetas disponibles para a√±adir (excluyendo las que ya est√°n en el calendario)
      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.textContent = receta.nombre;
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              agregarRecetaCalendario(receta.id, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      var modalElement = document.getElementById("seleccionarRecetaModal");
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
      
      // Al cerrar el modal, actualizar solo la comida afectada
      modalElement.addEventListener("hidden.bs.modal", function () {
      actualizarCalendario(fecha, mealType);
        });
    });

    function cargarRecetasA√±adidas(mealType, fecha) {
      var addedRecipeList = document.getElementById("addedRecipeList");
      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function cargarRecetasDisponibles(mealType, fecha) {
      var recipeList = document.getElementById("recipeList");
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.textContent = receta.nombre;
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              agregarRecetaCalendario(receta.id, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function actualizarCalendario(fecha, mealType) {
  console.log("üü¢ Actualizando calendario para la fecha:", fecha);

  fetch(`/api/calendario_dia/?fecha=${fecha}`)
    .then(response => response.json())
    .then(data => {
      console.log("üîµ Datos recibidos del backend:", data);

      var mealBlock = document.querySelector(`[data-fecha="${fecha}"][data-meal="${mealType}"]`);
      if (!mealBlock) return;

      // Buscar el contenedor existente de recetas
      var recipesContainer = mealBlock.querySelector(".meal-items");
      if (recipesContainer) {
        // Limpiar su contenido sin eliminar el contenedor
        recipesContainer.innerHTML = "";
      } else {
        // Si no existe, lo creamos y desactivamos los eventos para que no bloquee el click
        recipesContainer = document.createElement("div");
        recipesContainer.classList.add("meal-items");
        recipesContainer.style.pointerEvents = "none";
        mealBlock.appendChild(recipesContainer);
      }

      // Insertar las recetas de la respuesta
      if (data.recetas[mealType] && data.recetas[mealType].length > 0) {
        data.recetas[mealType].forEach(nombreReceta => {
          var recipeDiv = document.createElement("div");
          recipeDiv.classList.add("meal-item");
          recipeDiv.textContent = nombreReceta;
          // Los elementos individuales deben permitir recibir clics
          recipeDiv.style.pointerEvents = "auto";
          recipesContainer.appendChild(recipeDiv);
        });
      } else {
        recipesContainer.innerHTML = "";
      }
      actualizarBarraProteinas(fecha);

    })
    .catch(error => console.error("‚ùå Error al actualizar el calendario:", error));
}

    function agregarRecetaCalendario(recetaId, mealType, fecha) {
      console.log("Agregando receta:", recetaId, "a", mealType, "en", fecha);

      var tipoComidaId = mealMapping[mealType];

      fetch("/api/agregar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId,
          tipo_comida_id: tipoComidaId
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log("üîµ Respuesta del servidor (Agregar):", data);

          if (data.error) {
            console.error("Error:", data.error);
            return;
          }
          actualizarCalendario(fecha);  // üöÄ Se actualiza el calendario sin F5

          // ‚úÖ Actualizar din√°micamente la interfaz sin recargar
          cargarRecetasA√±adidas(mealType, fecha);
          cargarRecetasDisponibles(mealType, fecha);
        })
        .catch(() => console.error("Error al agregar la receta."));
    }


    function eliminarRecetaCalendario(recetaId, mealType, fecha) {
      fetch("/api/eliminar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error("Error:", data.error);
            return;
          }
          actualizarCalendario(fecha);  // üöÄ Se actualiza el calendario sin F5

          // ‚úÖ Actualizar din√°micamente la interfaz sin recargar
          cargarRecetasA√±adidas(mealType, fecha);
          cargarRecetasDisponibles(mealType, fecha);
        })
        .catch(() => console.error("Error al eliminar la receta."));
    }


  });
  </script>

</body>

</html>

{% endblock %}