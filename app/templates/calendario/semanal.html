{% extends 'navbar.html' %}

{% load dict_extras %}
{% load calendario_tags %}

{% block content %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Calendario Semanal</title>
  <!-- CSS de Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>



  <style>
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .navigation a {
      text-decoration: none;
      font-weight: bold;
      color: #333;
      padding: 5px 10px;
      border: 2px solid #ccc;
      border-radius: 5px;
    }

    .week-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .day-column {
      flex: 1;
      background-color: #FFEFE2;
      padding: 10px;
      border-radius: 15px;
      transition: background 0.5s ease-in-out;
    }

    .day-header {
      background-color: #FFD9C2;
      border-radius: 10px;
      padding: 5px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }

    .meal-block {
      background-color: #FFF8F5;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .meal-block:hover {
      background-color: #F8F1F0;
    }

    .meal-block h4 {
      margin: 0 0 5px;
    }

    .meal-item {
      background-color: #FFFFFF;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Estilos para la lista de recetas en el modal */
    .recipe-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .recipe-button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
    }

    .recipe-button:hover {
      background-color: #e2e6ea;
    }

    .day-column.today .day-header {
      background-color: #FFB29A; /* Por ejemplo, resaltar con el mismo rosa claro */
      color: #fff;
      font-size: 1.1em;
    }

    .circular-progress {
      position: relative;
      width: 100px;       /* Ajusta el tamaño */
      height: 100px;
      border-radius: 50%;
      background: conic-gradient(
        #ddd 0%,  /* color base */
        #ddd 100%
      );
    }

    /* Texto en el centro */
    .circular-progress .progress-value {
      position: absolute;
      inset: 0; /* top: 0; left: 0; right: 0; bottom: 0; */
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 1rem;
    }
    .circular-progress::before {
    content: "";
    position: absolute;
    /* Ajusta el inset para el grosor del anillo (cuanto más grande, más delgado el anillo) */
    inset: 15px;
    background: #fff; /* Color del "agujero" */
    border-radius: 50%;
  }
  /*******************************************/

  </style>
</head>

<body>
  <h1>Calendario Semanal</h1>
  <a href="{% url 'exportar_semana' %}?start={{ start_date|date:'Y-m-d' }}">
    Exportar recetas de la semana
  </a>

  <div class="container my-4">
    <h5 id="tituloProteinas"></h5>
    <!--
    <div class="progress">
      <div id="barraProteinas" class="progress-bar bg-success" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <p class="mt-2"><span id="consumidas">0</span>g consumidas</p>-->
    <div id="indicadorProteinas" style="display: flex; align-items: center; gap: 20px;">
      <svg class="donut-chart" id="donutChart" viewBox="0 0 100 100" width="100" height="100">
        <!-- Círculo de fondo -->
        <circle class="donut-bg" cx="50" cy="50" r="45" fill="none" stroke="#ddd" stroke-width="10" />
        <!-- Círculo de progreso con extremos redondeados -->
        <circle class="donut-progress" id="donutProgress" cx="50" cy="50" r="45" fill="none"
          stroke="#FFD9C2" stroke-width="10" stroke-linecap="round"
          stroke-dasharray="282.743" stroke-dashoffset="282.743" />
        <!-- Texto centrado -->
        <text id="donutText" x="50" y="50" text-anchor="middle" dy=".35em" font-size="18" fill="#333">0%</text>
      </svg>
      <!-- Texto extra (color-coded) opcional -->
      <p id="proteinaText" style="margin:0; font-size:1.2rem;"></p>
    </div>
    

    <div class="navigation">
      <a href="{{ prev_week_url }}">← Anterior</a>
      <a href="{% url 'calendario_semanal' %}">Hoy</a>
      <a href="{{ next_week_url }}">Siguiente →</a>
    </div>

    <div class="week-container">
      {% for day in dias %}
        {% get_calendario_for_date day as calendario %}

      <div class="day-column" id="day-column-{{ day|date:'Y-m-d' }}" style="{{ calendario|get_vertical_gradient_style }}">
        <div class="day-header">
          {{ day|date:"D" }}<br>
          {{ day|date:"d/m" }}<br>
          <span class="proteinas-valor">

          {{ calendario.proteinas_consumidas }}g / {{ calendario.objetivo_proteico }}g
        </span>

        </div>

        {% for meal in meal_order %}
        <div class="meal-block" data-meal="{{ meal }}" data-fecha="{{ day|date:'Y-m-d' }}">
          <h4>{{ meal }}</h4>
          <div class="meal-items" style="pointer-events: none;">

          {% for cr in dia_data|dictkey:day %}
            {% if cr.tipo_comida.nombre == meal %}
              <div class="meal-item">
                {{ cr.receta.nombre }}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

        {% endfor %}
      </div>
      {% endfor %}
    </div>

  <!-- Modal para seleccionar receta -->
  <div class="modal fade" id="seleccionarRecetaModal" tabindex="-1" aria-labelledby="seleccionarRecetaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gestión de recetas para 
            <span id="modalMealType">

            </span> del <span
              id="modalFecha"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Sección 1: Recetas ya añadidas con opción de eliminar -->
          <h6>Recetas añadidas:</h6>
          <div id="addedRecipeList" class="recipe-list mb-3">
            <p class="text-muted">Cargando...</p>
          </div>

          <hr>

          <!-- Sección 2: Lista de recetas disponibles para añadir -->
          <h6>Añadir nueva receta:</h6>
          <div id="recipeList" class="recipe-list">
            <p class="text-muted">Cargando...</p>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Obtenemos la fecha de hoy
      const hoy = new Date();
      // Definimos opciones de formateo en español: "20 de marzo de 2025"
      const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
      // Formateamos en español (es-ES)
      const fechaFormateada = hoy.toLocaleDateString('es-ES', opciones);
  
      // Insertamos el texto resultante
      document.getElementById("tituloProteinas").textContent =
        `Objetivo diario del ${fechaFormateada}`;
    });
  </script>
  

  <script>/*
    function actualizarBarraProteinas(fecha) {
      fetch(`/api/calendario_dia/?fecha=${fecha}`)
        .then(res => res.json())
        .then(data => {
          const objetivo = data.objetivo_proteico || 100;
          const consumidas = data.proteinas_consumidas || 0;
          const porcentaje = Math.min((consumidas / objetivo) * 100, 100);
          document.getElementById('barraProteinas').style.width = porcentaje + '%';
          document.getElementById('barraProteinas').textContent = `${Math.round(porcentaje)}%`;
          document.getElementById('consumidas').textContent = consumidas;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      actualizarBarraProteinas(new Date().toISOString().split('T')[0]);
    });*/
  </script>

  <script>
    // 1) Función para actualizar el donut
    function actualizarDonut(consumidas, objetivo) {
      const donutProgress = document.getElementById("donutProgress");
      const donutText = document.getElementById("donutText");
      if (!donutProgress || !donutText) return;

      const circumference = 2 * Math.PI * 45; // ≈ 282.743
      let porcentaje = 0;
      if (objetivo > 0) {
        porcentaje = Math.min((consumidas / objetivo) * 100, 100);
      }
      // Calcula el offset: al 100% el offset debe ser 0 (círculo lleno)
      const offset = circumference - (porcentaje / 100) * circumference;
      donutProgress.style.strokeDashoffset = offset;
      donutText.textContent = `${Math.round(porcentaje)}%`;
    }

    
    // 2) Función para actualizar el texto color-coded
    function actualizarTextoColor(consumidas, objetivo) {
      const proteinaText = document.getElementById("proteinaText");
      if (!proteinaText) return;
    
      let ratio = 0;
      if (objetivo > 0) ratio = consumidas / objetivo;
    
      let color = "red";
      if (ratio >= 1) color = "green";
      else if (ratio >= 0.5) color = "orange";
    
      proteinaText.style.color = color;
      proteinaText.textContent = `${consumidas}g / ${objetivo}g`;
    }
    
    // 3) Función que obtiene datos del día y llama a las anteriores
    function actualizarIndicadores(fecha) {
      fetch(`/api/calendario_dia/?fecha=${fecha}`)
        .then(res => res.json())
        .then(data => {
          const objetivo = data.objetivo_proteico || 100;
          const consumidas = data.proteinas_consumidas || 0;
    
          // Llamamos a las dos funciones
          actualizarDonut(consumidas, objetivo);
          actualizarTextoColor(consumidas, objetivo);
        })
        .catch(err => console.error("Error actualizando indicadores:", err));
    }
    
    // Llamada inicial al cargar la página
    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date().toISOString().split('T')[0];
      actualizarIndicadores(new Date().toISOString().split('T')[0]);
    });
  </script>
    

  <script>
    // Función para actualizar el degradado de un día dado (identificado por su fecha en formato YYYY-MM-DD)
    function actualizarDegradado(fecha) {
      fetch(`/api/dia/${fecha}/`)
        .then(response => response.json())
        .then(data => {
          if(data.error) {
            console.error(data.error);
            return;
          }
          const proteinas = data.proteinas_consumidas;
          const objetivo = data.objetivo_proteico;
          let porcentaje = 0;
          if(objetivo > 0) {
            porcentaje = Math.min(Math.max((proteinas / objetivo) * 100, 0), 100);
          }
          
          // Define los colores (ajusta según tu paleta)
          const colorSolido = "#FFD9C2";  // o el color que hayas elegido
          // Para un fade sutil: de colorSolido a transparente
          const colorTransparente = "rgba(0, 0, 0, 0)";
          
          let newStyle = "";
          if (porcentaje >= 100) {
            // Objetivo alcanzado: fondo completamente sólido
            newStyle = `background: ${colorSolido};`;
          } else {
            // Relleno parcial: degradado vertical
            // Usamos stops para tener mayor parte sólida y un fade sutil al final
            newStyle = `
              background: linear-gradient(to top, ${colorSolido} 0%, ${colorSolido} 98%, ${colorTransparente} 100%);
              background-repeat: no-repeat;
              background-size: 100% ${porcentaje}%;
              background-position: bottom;
            `;
          }
          // Actualizamos el estilo del elemento con id "day-column-<fecha>"
          const dayColumn = document.getElementById(`day-column-${fecha}`);
          if(dayColumn) {
            dayColumn.style = newStyle;
          }
        })
        .catch(err => console.error(err));
    }

    // Ejemplo de uso:
    // Supongamos que tienes una lista de fechas (en formato YYYY-MM-DD) en un array:
    const fechas = [/* lista de fechas, por ejemplo: "2025-03-17", "2025-03-18", ... */];

    // Función para actualizar todos los días (o bien llama a actualizarDegradado() cuando se añada/elimine una receta)
    function actualizarTodosLosDias() {
      fechas.forEach(fecha => {
        actualizarDegradado(fecha);
      });
    }

    // Llama a la función cuando la página se carga o tras una acción que modifique las recetas
    document.addEventListener("DOMContentLoaded", function() {
      actualizarTodosLosDias();
    });

    // Si tus acciones de agregar/eliminar recetas se hacen vía AJAX, puedes llamar a actualizarDegradado(fecha)
    // inmediatamente después de la operación para refrescar el degradado.
  </script>


  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var mealMapping = {{ meal_mapping|safe}};

    document.body.addEventListener("click", function (event) {
      var mealBlock = event.target.closest(".meal-block");
      if (!mealBlock) return;

      var mealType = mealBlock.dataset.meal;
      var fecha = mealBlock.dataset.fecha;

      document.getElementById("modalMealType").textContent = mealType;
      document.getElementById("modalFecha").textContent = fecha;
      document.getElementById("seleccionarRecetaModal").dataset.meal = mealType;
      document.getElementById("seleccionarRecetaModal").dataset.fecha = fecha;

      var addedRecipeList = document.getElementById("addedRecipeList");
      var recipeList = document.getElementById("recipeList");

      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      // 1️⃣ Cargar recetas ya añadidas
      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      // Cargar recetas disponibles para añadir (excluyendo las que ya están en el calendario)
      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.textContent = receta.nombre;
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              agregarRecetaCalendario(receta.id, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      var modalElement = document.getElementById("seleccionarRecetaModal");
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
      
      // Al cerrar el modal, actualizar solo la comida afectada
      modalElement.addEventListener("hidden.bs.modal", function () {
      actualizarCalendario(fecha, mealType);
        });
    });

    function cargarRecetasAñadidas(mealType, fecha) {
      var addedRecipeList = document.getElementById("addedRecipeList");
      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function cargarRecetasDisponibles(mealType, fecha) {
      var recipeList = document.getElementById("recipeList");
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.textContent = receta.nombre;
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              agregarRecetaCalendario(receta.id, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function actualizarCalendario(fecha, mealType) {
  console.log("🟢 Actualizando calendario para la fecha:", fecha);

  fetch(`/api/calendario_dia/?fecha=${fecha}`)
    .then(response => response.json())
    .then(data => {
      console.log("🔵 Datos recibidos del backend:", data);

      var mealBlock = document.querySelector(`[data-fecha="${fecha}"][data-meal="${mealType}"]`);
      if (!mealBlock) return;

      // Buscar el contenedor existente de recetas
      var recipesContainer = mealBlock.querySelector(".meal-items");
      if (recipesContainer) {
        // Limpiar su contenido sin eliminar el contenedor
        recipesContainer.innerHTML = "";
      } else {
        // Si no existe, lo creamos y desactivamos los eventos para que no bloquee el click
        recipesContainer = document.createElement("div");
        recipesContainer.classList.add("meal-items");
        recipesContainer.style.pointerEvents = "none";
        mealBlock.appendChild(recipesContainer);
      }

      // Insertar las recetas de la respuesta
      if (data.recetas[mealType] && data.recetas[mealType].length > 0) {
        data.recetas[mealType].forEach(nombreReceta => {
          var recipeDiv = document.createElement("div");
          recipeDiv.classList.add("meal-item");
          recipeDiv.textContent = nombreReceta;
          // Los elementos individuales deben permitir recibir clics
          recipeDiv.style.pointerEvents = "auto";
          recipesContainer.appendChild(recipeDiv);
        });
      } else {
        recipesContainer.innerHTML = "";
      }
      //actualizarBarraProteinas(fecha);
      actualizarDegradado(fecha);
      actualizarIndicadores(new Date().toISOString().split('T')[0]);

      // 4. Actualizamos el texto "xg / 100g" en la cabecera del día
      const dayColumn = document.getElementById(`day-column-${fecha}`);
      if (dayColumn) {
        const proteinaValor = dayColumn.querySelector('.proteinas-valor');
        if (proteinaValor) {
          proteinaValor.textContent = `${data.proteinas_consumidas}g / ${data.objetivo_proteico}g`;
        }
      }
    })
    .catch(error => console.error("❌ Error al actualizar el calendario:", error));
}

    function agregarRecetaCalendario(recetaId, mealType, fecha) {
      console.log("Agregando receta:", recetaId, "a", mealType, "en", fecha);

      var tipoComidaId = mealMapping[mealType];

      fetch("/api/agregar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId,
          tipo_comida_id: tipoComidaId
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log("🔵 Respuesta del servidor (Agregar):", data);

          if (data.error) {
            console.error("Error:", data.error);
            return;
          }
          actualizarCalendario(fecha);  // 🚀 Se actualiza el calendario sin F5

          // ✅ Actualizar dinámicamente la interfaz sin recargar
          cargarRecetasAñadidas(mealType, fecha);
          cargarRecetasDisponibles(mealType, fecha);
        })
        .catch(() => console.error("Error al agregar la receta."));
    }


    function eliminarRecetaCalendario(recetaId, mealType, fecha) {
      fetch("/api/eliminar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId,
          tipo_comida: mealType
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error("Error:", data.error);
            return;
          }
          actualizarCalendario(fecha);  // 🚀 Se actualiza el calendario sin F5

          // ✅ Actualizar dinámicamente la interfaz sin recargar
          cargarRecetasAñadidas(mealType, fecha);
          cargarRecetasDisponibles(mealType, fecha);
        })
        .catch(() => console.error("Error al eliminar la receta."));
    }


  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Obtiene la fecha actual en formato YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    // Busca el contenedor del día de hoy
    const todayColumn = document.getElementById(`day-column-${todayStr}`);
    if (todayColumn) {
      // Agrega la clase "today" para resaltarlo
      todayColumn.classList.add("today");
    }
  });
</script>


</body>

</html>

{% endblock %}