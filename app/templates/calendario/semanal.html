{% extends 'navbar.html' %}

{% load dict_extras %} 
{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario Semanal</title>
  <!-- CSS de Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



  <style>
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .navigation a {
      text-decoration: none;
      font-weight: bold;
      color: #333;
      padding: 5px 10px;
      border: 2px solid #ccc;
      border-radius: 5px;
    }

    .week-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .day-column {
      flex: 1;
      background-color: #FFEFE2;
      padding: 10px;
      border-radius: 15px;
    }
    .day-header {
      background-color: #FFD9C2;
      border-radius: 10px;
      padding: 5px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }

    .meal-block {
      background-color: #FFF8F5;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .meal-block:hover {
      background-color: #FFE0D6;
    }
    .meal-block h4 {
      margin: 0 0 5px;
    }

    .meal-item {
      background-color: #FFFFFF;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Estilos para la lista de recetas en el modal */
    .recipe-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .recipe-button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
    }
    .recipe-button:hover {
      background-color: #e2e6ea;
    }
  </style>
</head>
<body>
  <h1>Calendario Semanal</h1>

  <div class="navigation">
    <a href="{{ prev_week_url }}">← Anterior</a>
    <a href="{% url 'calendario_semanal' %}">Hoy</a>
    <a href="{{ next_week_url }}">Siguiente →</a>
  </div>

  <div class="week-container">
    {% for day in dias %}
      <div class="day-column">
        <div class="day-header">
          {{ day|date:"D" }}<br>
          {{ day|date:"d/m" }}
        </div>

        {% for meal in meal_order %}
        <div class="meal-block" data-meal="{{ meal }}" data-fecha="{{ day|date:'Y-m-d' }}">
          <h4>{{ meal }}</h4>
          {% for cr in dia_data|dictkey:day %}
            {% if cr.tipo_comida.nombre == meal %}
              <div class="meal-item">
                {{ cr.receta.nombre }}
              </div>
            {% endif %}
          {% endfor %}
        </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

<!-- Modal para seleccionar receta -->
<div class="modal fade" id="seleccionarRecetaModal" tabindex="-1" aria-labelledby="seleccionarRecetaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gestión de recetas para <span id="modalMealType"></span> del <span id="modalFecha"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">

        <!-- Sección 1: Recetas ya añadidas con opción de eliminar -->
        <h6>Recetas añadidas:</h6>
        <div id="addedRecipeList" class="recipe-list mb-3">
          <p class="text-muted">Cargando...</p>
        </div>

        <hr>

        <!-- Sección 2: Lista de recetas disponibles para añadir -->
        <h6>Añadir nueva receta:</h6>
        <div id="recipeList" class="recipe-list">
          <p class="text-muted">Cargando...</p>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var mealMapping = {{ meal_mapping|safe }};

    document.body.addEventListener("click", function (event) {
      var mealBlock = event.target.closest(".meal-block");
      if (!mealBlock) return;

      var mealType = mealBlock.dataset.meal;
      var fecha = mealBlock.dataset.fecha;

      document.getElementById("modalMealType").textContent = mealType;
      document.getElementById("modalFecha").textContent = fecha;

      document.getElementById("seleccionarRecetaModal").dataset.meal = mealType;
      document.getElementById("seleccionarRecetaModal").dataset.fecha = fecha;

      var addedRecipeList = document.getElementById("addedRecipeList");
      var recipeList = document.getElementById("recipeList");

      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      // 1️⃣ Cargar recetas ya añadidas
      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            addedRecipeList.innerHTML = "<p class='text-muted'>No hay recetas añadidas.</p>";
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      // 2️⃣ Cargar recetas disponibles para añadir
      fetch(`/api/recetas_por_tipo/?tipo=${mealType}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.textContent = receta.nombre;
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              agregarRecetaCalendario(receta.id, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      var modalElement = document.getElementById("seleccionarRecetaModal");
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
    });

    function agregarRecetaCalendario(recetaId, mealType, fecha) {
      var tipoComidaId = mealMapping[mealType];

      fetch("/api/agregar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId,
          tipo_comida_id: tipoComidaId
        })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.mensaje || "Receta agregada exitosamente.");
        location.reload();
      })
      .catch(() => alert("Error al agregar la receta."));
    }

    function eliminarRecetaCalendario(recetaId, mealType, fecha) {
      fetch("/api/eliminar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId
        })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.mensaje || "Receta eliminada correctamente.");
        location.reload();
      })
      .catch(() => alert("Error al eliminar la receta."));
    }
  });
</script>

</body>
</html>

{% endblock %}
