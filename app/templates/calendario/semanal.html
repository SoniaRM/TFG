{% extends 'navbar.html' %}

{% load dict_extras %}
{% load calendario_tags %}
{% load static %}

{% block content %}
<form id="dummy-form" style="display:none;">
  {% csrf_token %}
</form>

  <!-- CSS de Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
  <link rel="stylesheet" href="{% static 'css/calendario.css' %}">

  <div class="text-center my-3">
    <h1 class="mb-2">Calendario Semanal</h1>
  </div>  

  <div class="container my-4">
    <h5 id="tituloProteinas" class="lead text-center mb-4"></h5>
    <!--
    <div class="progress">
      <div id="barraProteinas" class="progress-bar bg-success" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <p class="mt-2"><span id="consumidas">0</span>g consumidas</p>-->

    <div class="position-relative my-4" style="height: 120px;">
      <!-- Indicador a la izquierda -->
      <div id="indicadorProteinas"
            class="indicador-proteinas position-absolute top-50 start-50 translate-middle">
        <svg class="donut-chart" id="donutChart" viewBox="0 0 100 100" width="100" height="100">
          <!-- Fondo -->
          <circle class="donut-bg" cx="50" cy="50" r="45" />
          <!-- Progreso -->
          <circle class="donut-progress" id="donutProgress" cx="50" cy="50" r="45" />
          <!-- Texto central -->
          <text id="donutText" class="donut-text" x="50" y="50" text-anchor="middle" dy=".35em">0%</text>
        </svg>
        <p id="proteinaText" class="proteina-text"></p>      
      </div>
      <!-- Espacio flexible para empujar el bot√≥n a la derecha -->
      <div class="flex-grow-1"></div>
      <!-- Bot√≥n de descarga -->
      <a href="{% url 'exportar_semana' %}?start={{ start_date|date:'Y-m-d' }}"
        class="btn btn-outline-primary btn-lg descarga-btn position-absolute top-50 end-0 translate-middle-y"
        aria-label="Descargar calendario semanal">
        <i class="bi bi-download"></i>
      </a>
    </div>
    
    <div class="navigation">
      <a href="{{ prev_week_url }}">‚Üê Anterior</a>
      <a href="{% url 'calendario_semanal' %}">‚Üí Esta semana</a>
      <a href="{{ next_week_url }}">Siguiente ‚Üí</a>
    </div>

    <div class="week-container">
      {% for day, nombre_corto in dias_context %}
        {% get_calendario_for_date fecha=day as calendario %}

      <div class="day-column" id="day-column-{{ day|date:'Y-m-d' }}" style="{{ calendario|get_vertical_gradient_style }}">
        <div class="day-header">
          {{ nombre_corto }}<br>
          {{ day|date:"d/m" }}<br>
          <p class="proteinas-valor mb-1">
            <strong>P:</strong> {{ calendario.proteinas_consumidas }}g / {{ calendario.objetivo_proteico }}g
          </p>
          <p class="carbohidratos-valor mb-0
            {% if calendario.carbohidratos_consumidos > calendario.objetivo_carbohidratos %}
                    carbs-exceso
            {% endif %}">
            <strong>C:</strong> {{ calendario.carbohidratos_consumidos }}g /
            {{ calendario.objetivo_carbohidratos }}g
          </p>
        </div>

        {% for meal in meal_order %}
        <div class="meal-block" data-meal="{{ meal }}" data-fecha="{{ day|date:'Y-m-d' }}">
          <h4>{{ meal }}</h4>
          <div class="meal-items" style="pointer-events: none;">

          {% for cr in dia_data|dictkey:day %}
            {% if cr.tipo_comida.nombre == meal %}
              <div class="meal-item">
                {{ cr.receta.nombre }}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

        {% endfor %}
      </div>
      {% endfor %}
    </div>

  <!-- Modal para seleccionar receta -->
  <div class="modal fade" id="seleccionarRecetaModal" tabindex="-1" aria-labelledby="seleccionarRecetaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gesti√≥n de recetas para 
            <span id="modalMealType">

            </span> del <span
              id="modalFecha"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Secci√≥n 1: Recetas ya a√±adidas con opci√≥n de eliminar -->
          <h6>Recetas a√±adidas:</h6>
          <div id="addedRecipeList" class="recipe-list mb-3">
            <p class="text-muted">Cargando...</p>
          </div>

          <hr>

          <!-- Secci√≥n 2: Lista de recetas disponibles para a√±adir -->
          <h6>A√±adir nueva receta:</h6>

          <input
            type="text"
            id="buscar-receta"
            class="form-control mb-2"
            placeholder="Buscar receta..."
          />
          <div id="recipeList" class="recipe-list">
            <p class="text-muted">Cargando...</p>
          </div>
          <button id="btn-ver-mas-recetas"
            class="btn btn-outline-secondary btn-sm mt-3 mb-2 float-end"
            style="display: none;">
              + Ver m√°s
          </button>
          <!-- Mensaje "No hay coincidencias" oculto por defecto -->
          <p id="no-coincidencias-recetas" style="display: none; color: red;">
            No hay coincidencias
          </p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Obtenemos la fecha de hoy
      const hoy = new Date();
      // Definimos opciones de formateo en espa√±ol: "20 de marzo de 2025"
      const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
      // Formateamos en espa√±ol (es-ES)
      const fechaFormateada = hoy.toLocaleDateString('es-ES', opciones);
  
      // Insertamos el texto resultante
      document.getElementById("tituloProteinas").textContent =
        `Registro proteico para hoy ${fechaFormateada}`;
    });
  </script>
  

  <script>/*
    function actualizarBarraProteinas(fecha) {
      fetch(`/api/calendario_dia/?fecha=${fecha}`)
        .then(res => res.json())
        .then(data => {
          const objetivo = data.objetivo_proteico || 100;
          const consumidas = data.proteinas_consumidas || 0;
          const porcentaje = Math.min((consumidas / objetivo) * 100, 100);
          document.getElementById('barraProteinas').style.width = porcentaje + '%';
          document.getElementById('barraProteinas').textContent = `${Math.round(porcentaje)}%`;
          document.getElementById('consumidas').textContent = consumidas;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      actualizarBarraProteinas(new Date().toISOString().split('T')[0]);
    });*/
  </script>

  <script>
    // 1) Funci√≥n para actualizar el donut
    function actualizarDonut(consumidas, objetivo) {
      const donutProgress = document.getElementById("donutProgress");
      const donutText = document.getElementById("donutText");
      if (!donutProgress || !donutText) return;

      const circumference = 2 * Math.PI * 45; // ‚âà 282.743
      let porcentaje = 0;
      if (objetivo > 0) {
        porcentaje = Math.min((consumidas / objetivo) * 100, 100);
      }
      // Calcula el offset: al 100% el offset debe ser 0 (c√≠rculo lleno)
      const offset = circumference - (porcentaje / 100) * circumference;
      donutProgress.style.strokeDashoffset = offset;
      donutText.textContent = `${Math.round(porcentaje)}%`;
    }

    
    // 2) Funci√≥n para actualizar el texto color-coded
    function actualizarTextoColor(consumidas, objetivo) {
      const proteinaText = document.getElementById("proteinaText");
      if (!proteinaText) return;
    
      let ratio = 0;
      if (objetivo > 0) ratio = consumidas / objetivo;
    
      let color = "red";
      if (ratio >= 1) color = "green";
      else if (ratio >= 0.5) color = "orange";
    
      proteinaText.style.color = color;
      proteinaText.textContent = `${consumidas}g / ${objetivo}g`;
    }
    
    // 3) Funci√≥n que obtiene datos del d√≠a y llama a las anteriores
    function actualizarIndicadores(fecha) {
      fetch(`/api/calendario_dia/?fecha=${fecha}`)
        .then(res => res.json())
        .then(data => {
          const objetivo = data.objetivo_proteico || 100;
          const consumidas = data.proteinas_consumidas || 0;

          // Llamamos a las dos funciones
          actualizarDonut(consumidas, objetivo);
          actualizarTextoColor(consumidas, objetivo);
        })
        .catch(err => console.error("Error actualizando indicadores:", err));
    }
    
    // Llamada inicial al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      const hoy = new Date().toISOString().split('T')[0];
      actualizarIndicadores(new Date().toISOString().split('T')[0]);
    });
  </script>
    

  <script>
    // Funci√≥n para actualizar el degradado de un d√≠a dado (identificado por su fecha en formato YYYY-MM-DD)
    function actualizarDegradado(fecha) {
      fetch(`/api/dia/${fecha}/`)
        .then(response => response.json())
        .then(data => {
          if(data.error) {
            console.error(data.error);
            return;
          }
          const proteinas = data.proteinas_consumidas;
          const objetivo = data.objetivo_proteico;
          let porcentaje = 0;
          if(objetivo > 0) {
            porcentaje = Math.min(Math.max((proteinas / objetivo) * 100, 0), 100);
          }
          
          // Define los colores (ajusta seg√∫n tu paleta)
          const estilos = getComputedStyle(document.documentElement);
          const colorSolido = estilos.getPropertyValue('--blue-dark').trim();
          // Para un fade sutil: de colorSolido a transparente
          const colorTransparente = "rgba(0, 0, 0, 0)";
          
          let newStyle = "";
          if (porcentaje >= 100) {
            // Objetivo alcanzado: fondo completamente s√≥lido
            newStyle = `background: ${colorSolido};`;
          } else {
            // Relleno parcial: degradado vertical
            // Usamos stops para tener mayor parte s√≥lida y un fade sutil al final
            newStyle = `
              background: linear-gradient(to top, ${colorSolido} 0%, ${colorSolido} 98%, ${colorTransparente} 100%);
              background-repeat: no-repeat;
              background-size: 100% ${porcentaje}%;
              background-position: bottom;
            `;
          }
          // Actualizamos el estilo del elemento con id "day-column-<fecha>"
          const dayColumn = document.getElementById(`day-column-${fecha}`);
          if(dayColumn) {
            dayColumn.style = newStyle;
          }
        })
        .catch(err => console.error(err));
    }

    // Ejemplo de uso:
    // Supongamos que tienes una lista de fechas (en formato YYYY-MM-DD) en un array:
    const fechas = [/* lista de fechas, por ejemplo: "2025-03-17", "2025-03-18", ... */];

    // Funci√≥n para actualizar todos los d√≠as (o bien llama a actualizarDegradado() cuando se a√±ada/elimine una receta)
    function actualizarTodosLosDias() {
      fechas.forEach(fecha => {
        actualizarDegradado(fecha);
      });
    }

    // Llama a la funci√≥n cuando la p√°gina se carga o tras una acci√≥n que modifique las recetas
    document.addEventListener("DOMContentLoaded", function() {
      actualizarTodosLosDias();
    });

    // Si tus acciones de agregar/eliminar recetas se hacen v√≠a AJAX, puedes llamar a actualizarDegradado(fecha)
    // inmediatamente despu√©s de la operaci√≥n para refrescar el degradado.
  </script>


  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var mealMapping = {{ meal_mapping|safe }};

      document.body.addEventListener("click", function(event) {
        var mb = event.target.closest(".meal-block");
        if (!mb) return;

      var mealType = mb.dataset.meal;
      var fecha    = mb.dataset.fecha;
      var modalEl  = document.getElementById("seleccionarRecetaModal");

      document.getElementById("modalMealType").textContent = mealType;
      document.getElementById("modalFecha").textContent = fecha;
      var modalEl = document.getElementById("seleccionarRecetaModal");
      modalEl.dataset.meal  = mealType;
      modalEl.dataset.fecha = fecha;

      var addedRecipeList = document.getElementById("addedRecipeList");
      var recipeList      = document.getElementById("recipeList");
      var verMasBtn       = document.getElementById("btn-ver-mas-recetas");

      // Estado inicial
      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";
      recipeList.innerHTML      = "<p class='text-muted'>Cargando...</p>";
      verMasBtn.style.display   = "none";

    // 1Ô∏è‚É£ Cargar recetas ya a√±adidas
    fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
      .then(res => res.json())
      .then(data => {
        addedRecipeList.innerHTML = "";
        if (data.length === 0) {
          addedRecipeList.innerHTML = "<p class='text-muted'>No hay recetas a√±adidas.</p>";
        } else {
          data.forEach(receta => {
            var div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2";
            var span = document.createElement("span");
            span.textContent = receta.nombre;
            var btn  = document.createElement("button");
            btn.className = "btn btn-danger btn-sm";
            btn.textContent = "Eliminar";
            btn.dataset.recetaId = receta.id;
            btn.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });
            div.appendChild(span);
            div.appendChild(btn);
            addedRecipeList.appendChild(div);
          });
        }
      })
      .catch(() => {
        addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
      });

      // 2Ô∏è‚É£ Paginaci√≥n de recetas disponibles
      let offset = 0, limit = 10;
      function loadRecipes() {
        fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}&limit=${limit}&offset=${offset}`)
          .then(res => res.json())
          .then(data => {
            if (offset === 0) recipeList.innerHTML = "";
            if (data.length === 0 && offset === 0) {
              recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
              verMasBtn.style.display = "none";
              return;
            }
            data.forEach(receta => {
              const btn = document.createElement("button");
              btn.className = "recipe-button btn btn-outline-primary mb-2 w-100";
              btn.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <span class="flex-grow-1 text-start recipe-name">${receta.nombre}</span>
                  <span class="badge score-badge">${receta.score}</span>
                </div>`;
              btn.dataset.recetaIds = JSON.stringify(receta.ids);
              btn.addEventListener("click", function () {
                const ids = JSON.parse(this.dataset.recetaIds);
                agregarRecetaCalendario(ids, mealType, fecha);
              });
              recipeList.appendChild(btn);
            });
            offset += data.length;
            verMasBtn.style.display = data.length < limit ? "none" : "block";
          })
          .catch(() => {
            recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
            verMasBtn.style.display = "none";
          });
      }
      verMasBtn.onclick = loadRecipes;

      // Mostrar modal y cargar la primera p√°gina
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
      loadRecipes();

      // Al cerrar el modal, refrescar s√≥lo la comida afectada
      modalEl.addEventListener("hidden.bs.modal", function () {
        actualizarCalendario(fecha, mealType);
      });

      // Cargar recetas disponibles para a√±adir (excluyendo las que ya est√°n en el calendario)
      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            button.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <span class="flex-grow-1 text-start recipe-name">${receta.nombre}</span>
                  <span class="badge score-badge">${receta.score}</span>
                </div>
              `;
            button.dataset.recetaIds = JSON.stringify(receta.ids);

            button.addEventListener("click", function () {
              const ids = JSON.parse(this.dataset.recetaIds);
              // La funci√≥n agregarRecetaCalendario deber√° adaptarse para aceptar un arreglo de IDs
              agregarRecetaCalendario(ids, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });

      var modalElement = document.getElementById("seleccionarRecetaModal");
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
      
      // Al cerrar el modal, actualizar solo la comida afectada
      modalElement.addEventListener("hidden.bs.modal", function () {
      actualizarCalendario(fecha, mealType);
        });
    });

    function cargarRecetasA√±adidas(mealType, fecha) {
      var addedRecipeList = document.getElementById("addedRecipeList");
      addedRecipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_en_calendario/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          addedRecipeList.innerHTML = "";
          if (data.length === 0) {
            return;
          }

          data.forEach(receta => {
            var div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            var span = document.createElement("span");
            span.textContent = receta.nombre;

            var button = document.createElement("button");
            button.classList.add("btn", "btn-danger", "btn-sm");
            button.textContent = "Eliminar";
            button.dataset.recetaId = receta.id;

            button.addEventListener("click", function () {
              eliminarRecetaCalendario(receta.id, mealType, fecha);
            });

            div.appendChild(span);
            div.appendChild(button);
            addedRecipeList.appendChild(div);
          });
        })
        .catch(() => {
          addedRecipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function cargarRecetasDisponibles(mealType, fecha) {
      var recipeList = document.getElementById("recipeList");
      recipeList.innerHTML = "<p class='text-muted'>Cargando...</p>";

      fetch(`/api/recetas_por_tipo/?tipo=${mealType}&fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
          recipeList.innerHTML = "";
          if (data.length === 0) {
            recipeList.innerHTML = "<p class='text-muted'>No hay recetas disponibles.</p>";
            return;
          }

          data.forEach(receta => {
            var button = document.createElement("button");
            button.classList.add("recipe-button", "btn", "btn-outline-primary", "mb-2", "w-100");
            // Diferenciar si es un par de recetas o una receta individual
            button.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <span class="flex-grow-1 text-start recipe-name">${receta.nombre}</span>
                  <span class="badge score-badge">${receta.score}</span>
                </div>
              `;
            // Guardamos el/los ID(s) en el atributo data, usando JSON para mayor flexibilidad
            button.dataset.recetaIds = JSON.stringify(receta.ids);
            // Al hacer clic, se recupera el arreglo de IDs y se llama a la funci√≥n de agregar recetas
            button.addEventListener("click", function() {
              const ids = JSON.parse(this.dataset.recetaIds);
              // La funci√≥n agregarRecetaCalendario deber√° adaptarse para aceptar un arreglo de IDs
              agregarRecetaCalendario(ids, mealType, fecha);
            });

            recipeList.appendChild(button);
          });
        })
        .catch(() => {
          recipeList.innerHTML = "<p class='text-danger'>Error al cargar recetas.</p>";
        });
    }

    function actualizarCalendario(fecha, mealType) {
  console.log("üü¢ Actualizando calendario para la fecha:", fecha);

  fetch(`/api/calendario_dia/?fecha=${fecha}`)
    .then(response => response.json())
    .then(data => {
      console.log("üîµ Datos recibidos del backend:", data);

      var mealBlock = document.querySelector(`[data-fecha="${fecha}"][data-meal="${mealType}"]`);
      if (!mealBlock) return;

      // Buscar el contenedor existente de recetas
      var recipesContainer = mealBlock.querySelector(".meal-items");
      if (recipesContainer) {
        // Limpiar su contenido sin eliminar el contenedor
        recipesContainer.innerHTML = "";
      } else {
        // Si no existe, lo creamos y desactivamos los eventos para que no bloquee el click
        recipesContainer = document.createElement("div");
        recipesContainer.classList.add("meal-items");
        recipesContainer.style.pointerEvents = "none";
        mealBlock.appendChild(recipesContainer);
      }

      // Insertar las recetas de la respuesta
      if (data.recetas[mealType] && data.recetas[mealType].length > 0) {
        data.recetas[mealType].forEach(nombreReceta => {
          var recipeDiv = document.createElement("div");
          recipeDiv.classList.add("meal-item");
          recipeDiv.textContent = nombreReceta;
          // Los elementos individuales deben permitir recibir clics
          recipeDiv.style.pointerEvents = "auto";
          recipesContainer.appendChild(recipeDiv);
        });
      } else {
        recipesContainer.innerHTML = "";
      }


      //actualizarBarraProteinas(fecha);
      actualizarDegradado(fecha);
      actualizarIndicadores(new Date().toISOString().split('T')[0]);

      // 4. Actualizamos el texto "xg / 100g" en la cabecera del d√≠a
      const dayColumn = document.getElementById(`day-column-${fecha}`);
      if (dayColumn) {
        const proteinaValor = dayColumn.querySelector('.proteinas-valor');
        if (proteinaValor) {
          proteinaValor.textContent = `P: ${data.proteinas_consumidas}g / ${data.objetivo_proteico}g`;
        }
        const carboValor = dayColumn.querySelector('.carbohidratos-valor');
        if (carboValor) {
          carboValor.textContent = `C: ${data.carbohidratos_consumidos}g / ${data.objetivo_carbohidratos}g`;
        }
        // 3) **Actualiza los carbohidratos**:
        const carbsElem = dayColumn.querySelector('.carbohidratos-valor');
        if (carbsElem) {
          carbsElem.textContent = `C: ${data.carbohidratos_consumidos}g / ${data.objetivo_carbohidratos}g`;

          // 4) Aplica el ‚Äúshake‚Äù si hemos excedido
          if (data.carbohidratos_consumidos > data.objetivo_carbohidratos) {
            carbsElem.classList.add('carbs-exceso');
          } else {
            carbsElem.classList.remove('carbs-exceso');
          }

        }
      }
      

    })
    .catch(error => console.error("‚ùå Error al actualizar el calendario:", error));
}

function agregarRecetaCalendario(ids, mealType, fecha) {

  if (!Array.isArray(ids)) {
    // Puede que venga como undefined o como un n√∫mero
    if (typeof ids === "undefined") {
      console.error("Error: el par√°metro ids es undefined.");
      return;
    }
    ids = [ids];
  }
  console.log("Agregando recetas:", ids, "para", mealType, "en", fecha);

  var tipoComidaId = mealMapping[mealType];

  const requests = ids.map(recetaId => {
    return fetch("/api/agregar_receta_calendario/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: new URLSearchParams({
        fecha: fecha,
        receta_id: recetaId,
        tipo_comida_id: tipoComidaId
      })
    })
      .then(response => response.json())
      .catch(error => {
        console.error("Error en fetch para receta", recetaId, error);
        throw error;
      });
  });

  Promise.all(requests)
    .then(results => {
      console.log("üîµ Respuesta del servidor (Agregar):", results);
      
      // Opcional: verificar si alguna respuesta tiene error
      const errores = results.filter(res => res.error);
      if (errores.length > 0) {
        console.error("Errores al agregar recetas:", errores);
        alert("Hubo un error al agregar algunas recetas. Revisa la consola.");
      }
      
      actualizarCalendario(fecha, mealType);  // Actualiza el calendario
      cargarRecetasA√±adidas(mealType, fecha);    // Actualiza la lista de recetas a√±adidas
      cargarRecetasDisponibles(mealType, fecha);   // Actualiza las recetas disponibles

      const buscarRecetaInput = document.getElementById("buscar-receta");
      if (buscarRecetaInput) {
        buscarRecetaInput.value = "";
        const eventoKeyUp = new Event("keyup");
        buscarRecetaInput.dispatchEvent(eventoKeyUp);
      }
    })
    .catch(error => {
      console.error("Error al agregar la receta:", error);
      alert("Error al agregar la receta. Revisa la consola para m√°s detalles.");
    });
}
/*******************************/
/*************************************/

    function eliminarRecetaCalendario(recetaId, mealType, fecha) {
      fetch("/api/eliminar_receta_calendario/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
          fecha: fecha,
          receta_id: recetaId,
          tipo_comida: mealType
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error("Error:", data.error);
            return;
          }
          actualizarCalendario(fecha);  // üöÄ Se actualiza el calendario sin F5

          // ‚úÖ Actualizar din√°micamente la interfaz sin recargar
          cargarRecetasA√±adidas(mealType, fecha);
          cargarRecetasDisponibles(mealType, fecha);
        })
        .catch(() => console.error("Error al eliminar la receta."));
    }


  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Obtiene la fecha actual en formato YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    // Busca el contenedor del d√≠a de hoy
    const todayColumn = document.getElementById(`day-column-${todayStr}`);
    if (todayColumn) {
      // Agrega la clase "today" para resaltarlo
      todayColumn.classList.add("today");
    }
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const buscarRecetaInput = document.getElementById("buscar-receta");
  if (!buscarRecetaInput) return;

  buscarRecetaInput.addEventListener("keyup", function() {
    const filtro = this.value.toLowerCase();
    const recipeList = document.getElementById("recipeList");
    const noCoincidencias = document.getElementById("no-coincidencias-recetas");

    if (!recipeList) return;

    // Selecciona todos los botones de receta
    const recipeButtons = recipeList.querySelectorAll(".recipe-button");

    recipeButtons.forEach((btn) => {
      const textoReceta = btn.textContent.toLowerCase();
      if (textoReceta.includes(filtro)) {
        btn.style.display = "";
      } else {
        btn.style.display = "none";
      }
    });
  });
});
</script>

{% endblock %}