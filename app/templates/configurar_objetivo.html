{% extends 'navbar.html' %}
{% block title %}Configurar Objetivo{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .card-form {
    background-color: #FFF8F5;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin: 20px auto;
    max-width: 600px;
  }

  .card-form h2 {
    background-color: #FFD9C2;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
    margin-bottom: 20px;
  }

  .card-familia {
    background-color: #e8f0fe;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    padding: 15px;
    margin-top: 20px;
  }
</style>
<div class="container mt-4">
  <div class="card-form">
    <h2>Configurar objetivo diario</h2>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-primary">Guardar</button>
    </form>

    <!-- Mostrar la información de la familia -->
    {% with familia=request.user.familias.first %}
    {% if familia %}
    <div class="card-familia">
      <h4 class="text-center">Mi Familia</h4>
      <p><strong>Nombre:</strong> {{ familia.nombre }}</p>
      <p><strong>Código de invitación:</strong> {{ familia.codigo_invitacion }}</p>
      <p class="text-muted">Comparte este código con quien desees invitar.</p>
      <h4>Miembros de la familia:</h4>
      <ul>
        {% for miembro in familia.miembros.all %}
        <li>
          {{ miembro.username }}
          {% if miembro == familia.administrador %}
          <span style="color: red;">(Administrador)</span>
          {% elif request.user == familia.administrador %}
          <!-- Solo muestra el botón si el usuario actual es el administrador -->
          <button
            type="button"
            class="btn btn-sm btn-danger"
            data-url="{% url 'eliminar_miembro' miembro.id %}"
            onclick="confirmarEliminacion(this)">
            Eliminar
          </button>
          {% endif %}
        </li>
        {% empty %}
        <li>No hay miembros asignados aún.</li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="card-familia">
      <p>No se encontró ninguna familia asignada.</p>
    </div>
    {% endif %}
    {% endwith %}

    <!-- Formulario para cerrar sesión -->
    <div class="container mt-4">
      <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Cerrar Sesión</button>
      </form>
    </div>
  </div>

</div>
<!-- Modal de Confirmación para eliminar miembro -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center" style="border-radius: 15px; background-color: #FFF8F5;">
      <div class="modal-header">
        <h5 class="modal-title w-100" id="confirmDeleteModalLabel">¿Eliminar miembro?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar a este miembro de la familia?</p>
        <form id="deleteForm" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Sí, eliminar</button>
          <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancelar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Función que asigna la URL al form del modal y lo muestra
  function confirmarEliminacion(button) {
    const url = button.getAttribute('data-url');
    const form = document.getElementById('deleteForm');
    form.action = url;
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
  }
  </script>

{% if exito %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mostrarSuccessModal();
    setTimeout(() => {
      window.location.href = "{% url 'calendario_semanal' %}";
    }, 1000);
  });
</script>
{% endif %}
{% endblock %}