{% extends 'navbar.html' %}

{% block title %}Lista de la compra{% endblock %}

{% block content %}
<form id="dummy-form" style="display:none;">
    {% csrf_token %}
</form>

<div class="container">
    <h1>Lista de la compra</h1>
    <p><strong>Semana del:</strong> {{ semana_formateada }}</p>

    <div class="navigation">
        <a href="{{ prev_week_url }}">← Semana anterior</a> |
        <!-- Botón "Esta semana" -->
        <a href="?start={{ today|date:'Y-m-d' }}">Esta semana</a> |
        <a href="{{ next_week_url }}">Semana siguiente →</a>
    </div>

    <!-- Botón para activar "Modo super" -->
    <button id="btn-modo-super" onclick="activarModoSuper()">Modo super</button>


    {% if ingredientes_por_comprar or ingredientes_en_despensa %}
        <h2>Ingredientes por comprar</h2>
        <ul id="lista-compra">
            {% for item in ingredientes_por_comprar %}
                <li data-item-id="{{ item.id }}" data-lista-id="{{ item.lista_id }}">
                    <strong>{{ item.ingrediente.nombre }}</strong>
                    – <span class="compra-value">{{ item.compra }}</span> raciones
                    <button onclick="abrirModalCompra({{ item.id }}, {{ item.compra }})">Ya lo tengo</button>
                </li>
            {% endfor %}
        </ul>

        <h2>Ingredientes en la despensa</h2>
        <ul id="ingredientes-despensa">
            {% for item in ingredientes_en_despensa %}
                <li data-item-id="{{ item.id }}" data-lista-id="{{ item.lista_id }}">
                    <strong>{{ item.ingrediente.nombre }}</strong>
                    – Tengo <span class="despensa-value">{{ item.despensa }}</span> 
                    (Faltan {{ item.faltan }})
                    <button onclick="abrirModalDespensa({{ item.id }}, {{ item.despensa }})">Devolver</button>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay ingredientes para esta semana.</p>
    {% endif %}

    <button onclick="resetearLista()" class="btn-reset">Reiniciar Lista</button>
</div>


<!-- SECCIÓN MODO SUPER (OCULTA POR DEFECTO) -->
<div id="modo-super" style="display:none; padding: 20px;">
    <h2>Modo supermercado</h2>
    <button id="btn-atras" onclick="desactivarModoSuper()">Atrás</button>

    <div style="display: flex; gap: 40px;">
      <!-- Lista de ingredientes por comprar -->
      <div>
        <h3>Ingredientes por comprar</h3>
        <ul id="super-por-comprar"></ul>
      </div>
      <!-- Lista de ingredientes en la cesta -->
      <div>
        <h3>Ingredientes en la cesta</h3>
        <ul id="super-cesta"></ul>
      </div>
    </div>
    <button id="btn-comprar" onclick="finalizarCompra()">Comprar</button>
</div>

<!-- Modal para mover de compra -> despensa -->
<div id="modal-compra" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background-color: rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:white; width:320px; margin:10% auto; padding:20px; 
              border-radius:10px; text-align:center; position:relative;">
      <h3 id="modal-compra-titulo"></h3>
      <p>Selecciona cuántas raciones tienes:</p>
      <div id="raciones-opciones-compra" 
           style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
      <br>
      <button onclick="cerrarModalCompra()">Cancelar</button>
  </div>
</div>

<!-- Modal para mover de despensa -> compra -->
<div id="modal-despensa"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background-color: rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:white; width:320px; margin:10% auto; padding:20px; 
              border-radius:10px; text-align:center; position:relative;">
      <h3 id="modal-despensa-titulo"></h3>
      <p>Selecciona cuántas raciones devuelves a la compra:</p>
      <div id="raciones-opciones-despensa" 
           style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
      <br>
      <button onclick="cerrarModalDespensa()">Cancelar</button>
  </div>
</div>

<script>
function abrirModalCompra(itemId, compraActual) {
    // Mostramos el overlay
    const modal = document.getElementById('modal-compra');
    modal.style.display = 'block';

    document.getElementById('modal-compra-titulo').textContent = "¿Cuántas raciones tienes?";

    // Generar botones
    let cont = document.getElementById('raciones-opciones-compra');
    cont.innerHTML = '';
    for (let i = 1; i <= compraActual; i++) {
        let btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '5px';
        btn.onclick = () => moverCompraADespensa(itemId, i);
        cont.appendChild(btn);
    }
}
function cerrarModalCompra() {
    document.getElementById('modal-compra').style.display = 'none';
}

function abrirModalDespensa(itemId, despensaActual) {
    const modal = document.getElementById('modal-despensa');
    modal.style.display = 'block';

    document.getElementById('modal-despensa-titulo').textContent = "¿Cuántas raciones devuelves a la compra?";

    let cont = document.getElementById('raciones-opciones-despensa');
    cont.innerHTML = '';
    for (let i = 1; i <= despensaActual; i++) {
        let btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '5px';
        btn.onclick = () => moverDespensaACompra(itemId, i);
        cont.appendChild(btn);
    }
}

function cerrarModalDespensa() {
    document.getElementById('modal-despensa').style.display = 'none';
}

function moverCompraADespensa(itemId, raciones) {
    // 1) Recogemos el lista_id del <li>
    let li = document.querySelector(`[data-item-id='${itemId}']`);
    let listaId = li.dataset.listaId;

    // 2) POST a /mover_compra_despensa/
    fetch("/mover_compra_despensa/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            'lista_id': listaId,
            'item_id': itemId,
            'raciones': raciones
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            cerrarModalCompra();
            refrescarDatos();
        }
    })
    .catch(err => console.error(err));
}

function moverDespensaACompra(itemId, raciones) {
    let li = document.querySelector(`[data-item-id='${itemId}']`);
    let listaId = li.dataset.listaId;

    fetch("/mover_despensa_compra/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            'lista_id': listaId,
            'item_id': itemId,
            'raciones': raciones
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            cerrarModalDespensa();
            refrescarDatos();
        }
    })
    .catch(err => console.error(err));
}

function refrescarDatos() {
    // Hacemos un GET a /lista_compra/datos?start=...
    // Extraemos la "start_date" actual desde la URL
    let urlParams = new URLSearchParams(window.location.search);
    let start = urlParams.get('start') || "{{ start_date|date:'Y-m-d' }}";
    fetch(`/lista_compra/datos?start=${start}`)
      .then(res => res.json())
      .then(data => {
          // 1) Vaciar los UL
          document.getElementById("lista-compra").innerHTML = "";
          document.getElementById("ingredientes-despensa").innerHTML = "";
          // 2) Llenar con data.por_comprar y data.en_despensa
          data.por_comprar.forEach(item => {
              let li = document.createElement('li');
              li.dataset.itemId = item.item_id;
              li.dataset.listaId = item.lista_id;
              li.innerHTML = `<strong>${item.ingrediente}</strong> – <span class="compra-value">${item.compra}</span> raciones
                <button onclick="abrirModalCompra(${item.item_id}, ${item.compra})">Ya lo tengo</button>`;
              document.getElementById("lista-compra").appendChild(li);
          });

          data.en_despensa.forEach(item => {
              console.log("item.original =", item.original, "item.despensa =", item.despensa);
              console.log("FALTAN =", item.faltan);
              let li = document.createElement('li');
              li.dataset.itemId = item.item_id;
              li.dataset.listaId = item.lista_id;
              li.innerHTML = `<strong>${item.ingrediente}</strong> – Tengo <span class="despensa-value">${item.despensa}</span> (Faltan ${item.faltan})
                <button onclick="abrirModalDespensa(${item.item_id}, ${item.despensa})">Devolver</button>`;
              document.getElementById("ingredientes-despensa").appendChild(li);
          });
      })
      .catch(err => console.error(err));
}

function resetearLista() {
    if (!confirm("¿Estás seguro de que quieres reiniciar la lista de la compra?")) return;
    
    // Obtener la fecha de inicio desde la URL o usar el start_date
    let urlParams = new URLSearchParams(window.location.search);
    let start = urlParams.get('start') || "{{ start_date|date:'Y-m-d' }}";
    
    fetch(`/lista_compra/reset/?start=${start}`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert(data.mensaje);
            location.reload();
        }
    })
    .catch(err => console.error(err));
}

// ========== BOTÓN PARA ACTIVAR MODO SUPER ==========
function activarModoSuper() {
      // Mostramos la sección "modo-super" y ocultamos la vista normal (o viceversa)
      const modoSuperDiv = document.getElementById('modo-super');
      const container = document.querySelector('.container');
      // Por ejemplo, ocultar la .container y mostrar modo-super:
      container.style.display = 'none';
      modoSuperDiv.style.display = 'block';

      // Llenar la lista "super-por-comprar" con los ingredientes actuales de "por comprar"
      // Podríamos usar la data actual del DOM o llamar a refrescarDatos() si tienes un array local.
      inicializarModoSuper();
  }

 // ========== INICIALIZAR MODO SUPER ==========
 function inicializarModoSuper() {
      // 1) Limpiamos las listas
      document.getElementById('super-por-comprar').innerHTML = "";
      document.getElementById('super-cesta').innerHTML = "";

      // 2) Recorremos la lista de compra actual del DOM
      let porComprarItems = document.querySelectorAll('#lista-compra li[data-item-id]');
      porComprarItems.forEach(li => {
          let itemId = li.dataset.itemId;
          let listaId = li.dataset.listaId;
          let nombre = li.querySelector('strong').textContent.trim();
          let compra = li.querySelector('.compra-value').textContent.trim();

          // Crear un li en super-por-comprar
          let nuevoLi = document.createElement('li');
          nuevoLi.dataset.itemId = itemId;
          nuevoLi.dataset.listaId = listaId;
          nuevoLi.dataset.nombre = nombre;
          nuevoLi.dataset.cantidad = compra;
          nuevoLi.innerHTML = `
            <strong>${nombre}</strong> – <span>${compra}</span> raciones
            <button onclick="moverACesta('${itemId}')">✔</button>
          `;
          document.getElementById('super-por-comprar').appendChild(nuevoLi);
      });
  }

  
  // ========== MOVER A CESTA ==========
  function moverACesta(itemId) {
      // Buscamos el li en super-por-comprar
      let li = document.querySelector(`#super-por-comprar li[data-item-id='${itemId}']`);
      if (!li) return;

      // Lo quitamos de super-por-comprar y lo metemos en super-cesta
      li.remove();
      li.innerHTML = `
        <strong>${li.dataset.nombre}</strong> – <span>${li.dataset.cantidad}</span> raciones
        <button onclick="moverAListaPorComprar('${itemId}')">X</button>
      `;
      document.getElementById('super-cesta').appendChild(li);
  }

  
  // ========== MOVER A LISTA POR COMPRAR ==========
  function moverAListaPorComprar(itemId) {
      let li = document.querySelector(`#super-cesta li[data-item-id='${itemId}']`);
      if (!li) return;
      li.remove();
      li.innerHTML = `
        <strong>${li.dataset.nombre}</strong> – <span>${li.dataset.cantidad}</span> raciones
        <button onclick="moverACesta('${itemId}')">✔</button>
      `;
      document.getElementById('super-por-comprar').appendChild(li);
  }

   // ========== BOTÓN "COMPRAR" ==========
   function finalizarCompra() {
      // Recorrer la super-cesta y obtener los ingredientes
      let cestaItems = document.querySelectorAll('#super-cesta li[data-item-id]');
      let cestaData = [];
      cestaItems.forEach(li => {
          cestaData.push({
              item_id: li.dataset.itemId,
              lista_id: li.dataset.listaId,
              nombre: li.dataset.nombre,
              cantidad: li.dataset.cantidad
          });
      });

      // Hacemos un fetch POST a un nuevo endpoint, por ejemplo "/finalizar_compra/"
      // que en el servidor actualiza la despensa de esa semana para esos ingredientes.
      // Te sugiero crear una vista "finalizar_compra" que reciba la lista de items y 
      // haga item.despensa += X en la BD, o como tú desees.
      fetch("/finalizar_compra/", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({ items: cestaData, start: "{{ start_date|date:'Y-m-d' }}" })
      })
      .then(res => res.json())
      .then(data => {
          if (data.error) {
              alert("Error al comprar: " + data.error);
          } else {
              alert("¡Compra realizada! Se han actualizado las raciones en la despensa.");
              // Opcional: recargar la página o llamar a refrescarDatos()
              location.reload();
          }
      })
      .catch(err => console.error(err));
  }
  function desactivarModoSuper() {
    // Oculta la sección Modo Super y muestra la vista normal
    document.getElementById('modo-super').style.display = 'none';
    // Asumiendo que la vista normal está en un contenedor con clase .container
    document.querySelector('.container').style.display = 'block';
}


</script>

{% endblock %}