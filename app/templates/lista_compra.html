{% extends 'navbar.html' %}

{% block title %}Lista de la compra{% endblock %}

{% block content %}
<form id="dummy-form" style="display:none;">
    {% csrf_token %}
</form>

<div class="container">
    <h1>Lista de la compra</h1>
    <p><strong>Semana del:</strong> {{ semana_formateada }}</p>

    <div class="navigation">
        <a href="{{ prev_week_url }}">← Semana anterior</a> |
        <!-- Botón "Esta semana" -->
        <a href="?start={{ today|date:'Y-m-d' }}">Esta semana</a> |
        <a href="{{ next_week_url }}">Semana siguiente →</a>
    </div>

    {% if ingredientes_por_comprar or ingredientes_en_despensa %}
        <h2>Ingredientes por comprar</h2>
        <ul id="lista-compra">
            {% for item in ingredientes_por_comprar %}
                <li data-item-id="{{ item.id }}" data-lista-id="{{ item.lista_id }}">
                    <strong>{{ item.ingrediente.nombre }}</strong>
                    – <span class="compra-value">{{ item.compra }}</span> raciones
                    <button onclick="abrirModalCompra({{ item.id }}, {{ item.compra }})">Ya lo tengo</button>
                </li>
            {% endfor %}
        </ul>

        <h2>Ingredientes en la despensa</h2>
        <ul id="ingredientes-despensa">
            {% for item in ingredientes_en_despensa %}
                <li data-item-id="{{ item.id }}" data-lista-id="{{ item.lista_id }}">
                    <strong>{{ item.ingrediente.nombre }}</strong>
                    – Tengo <span class="despensa-value">{{ item.despensa }}</span> 
                    (Faltan {{ item.faltan }})
                    <button onclick="abrirModalDespensa({{ item.id }}, {{ item.despensa }})">Devolver</button>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay ingredientes para esta semana.</p>
    {% endif %}

    <button onclick="resetearLista()" class="btn-reset">Reiniciar Lista</button>
</div>

<!-- Modal para mover de compra -> despensa -->
<div id="modal-compra" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background-color: rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:white; width:320px; margin:10% auto; padding:20px; 
              border-radius:10px; text-align:center; position:relative;">
      <h3 id="modal-compra-titulo"></h3>
      <p>Selecciona cuántas raciones tienes:</p>
      <div id="raciones-opciones-compra" 
           style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
      <br>
      <button onclick="cerrarModalCompra()">Cancelar</button>
  </div>
</div>

<!-- Modal para mover de despensa -> compra -->
<div id="modal-despensa"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background-color: rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:white; width:320px; margin:10% auto; padding:20px; 
              border-radius:10px; text-align:center; position:relative;">
      <h3 id="modal-despensa-titulo"></h3>
      <p>Selecciona cuántas raciones devuelves a la compra:</p>
      <div id="raciones-opciones-despensa" 
           style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
      <br>
      <button onclick="cerrarModalDespensa()">Cancelar</button>
  </div>
</div>

<script>
function abrirModalCompra(itemId, compraActual) {
    // Mostramos el overlay
    const modal = document.getElementById('modal-compra');
    modal.style.display = 'block';

    document.getElementById('modal-compra-titulo').textContent = "¿Cuántas raciones tienes?";

    // Generar botones
    let cont = document.getElementById('raciones-opciones-compra');
    cont.innerHTML = '';
    for (let i = 1; i <= compraActual; i++) {
        let btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '5px';
        btn.onclick = () => moverCompraADespensa(itemId, i);
        cont.appendChild(btn);
    }
}
function cerrarModalCompra() {
    document.getElementById('modal-compra').style.display = 'none';
}

function abrirModalDespensa(itemId, despensaActual) {
    const modal = document.getElementById('modal-despensa');
    modal.style.display = 'block';

    document.getElementById('modal-despensa-titulo').textContent = "¿Cuántas raciones devuelves a la compra?";

    let cont = document.getElementById('raciones-opciones-despensa');
    cont.innerHTML = '';
    for (let i = 1; i <= despensaActual; i++) {
        let btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '5px';
        btn.onclick = () => moverDespensaACompra(itemId, i);
        cont.appendChild(btn);
    }
}

function cerrarModalDespensa() {
    document.getElementById('modal-despensa').style.display = 'none';
}

function moverCompraADespensa(itemId, raciones) {
    // 1) Recogemos el lista_id del <li>
    let li = document.querySelector(`[data-item-id='${itemId}']`);
    let listaId = li.dataset.listaId;

    // 2) POST a /mover_compra_despensa/
    fetch("/mover_compra_despensa/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            'lista_id': listaId,
            'item_id': itemId,
            'raciones': raciones
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            cerrarModalCompra();
            refrescarDatos();
        }
    })
    .catch(err => console.error(err));
}

function moverDespensaACompra(itemId, raciones) {
    let li = document.querySelector(`[data-item-id='${itemId}']`);
    let listaId = li.dataset.listaId;

    fetch("/mover_despensa_compra/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            'lista_id': listaId,
            'item_id': itemId,
            'raciones': raciones
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            cerrarModalDespensa();
            refrescarDatos();
        }
    })
    .catch(err => console.error(err));
}

function refrescarDatos() {
    // Hacemos un GET a /lista_compra/datos?start=...
    // Extraemos la "start_date" actual desde la URL
    let urlParams = new URLSearchParams(window.location.search);
    let start = urlParams.get('start') || "{{ start_date|date:'Y-m-d' }}";
    fetch(`/lista_compra/datos?start=${start}`)
      .then(res => res.json())
      .then(data => {
          // 1) Vaciar los UL
          document.getElementById("lista-compra").innerHTML = "";
          document.getElementById("ingredientes-despensa").innerHTML = "";
          // 2) Llenar con data.por_comprar y data.en_despensa
          data.por_comprar.forEach(item => {
              let li = document.createElement('li');
              li.dataset.itemId = item.item_id;
              li.dataset.listaId = item.lista_id;
              li.innerHTML = `<strong>${item.ingrediente}</strong> – <span class="compra-value">${item.compra}</span> raciones
                <button onclick="abrirModalCompra(${item.item_id}, ${item.compra})">Ya lo tengo</button>`;
              document.getElementById("lista-compra").appendChild(li);
          });

          data.en_despensa.forEach(item => {
              console.log("item.original =", item.original, "item.despensa =", item.despensa);
              console.log("FALTAN =", item.faltan);
              let li = document.createElement('li');
              li.dataset.itemId = item.item_id;
              li.dataset.listaId = item.lista_id;
              li.innerHTML = `<strong>${item.ingrediente}</strong> – Tengo <span class="despensa-value">${item.despensa}</span> (Faltan ${item.faltan})
                <button onclick="abrirModalDespensa(${item.item_id}, ${item.despensa})">Devolver</button>`;
              document.getElementById("ingredientes-despensa").appendChild(li);
          });
      })
      .catch(err => console.error(err));
}

function resetearLista() {
    if (!confirm("¿Estás seguro de que quieres reiniciar la lista de la compra?")) return;
    // Podrías crear una vista /lista_compra/reset?start=... que borre todos los items
    // o reasigne compra=original, despensa=0
    // y luego hacer refrescarDatos() o recargar la página
    alert("Implementa una vista para resetear la DB si lo deseas :)");
}
</script>

{% endblock %}